<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nim Game Ultimate</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f2f2f2;
  margin: 0;
  padding: 10px;
  text-align: center;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
  margin-bottom: 8px;
}

select, button, input {
  font-size: 14px;
  padding: 5px 8px;
}

.piles {
  display: flex;
  flex-direction: column; /* å±±ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
  gap: 10px;
  align-items: center;
}

.pile {
  background: white;
  border-radius: 10px;
  padding: 8px 12px;
  width: 100%;
  max-width: 420px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.stones {
  display: flex; /* çŸ³ã¯æ¨ªä¸¦ã³ */
  gap: 4px;
  font-size: 22px;
  user-select: none;
}

.stone {
  cursor: pointer;
}

.stone.selected {
  color: red;
}

.pending {
  margin-top: 6px;
}

#message {
  margin-top: 8px;
  font-size: 18px;
  font-weight: bold;
}

.win {
  animation: win 0.6s ease-in-out infinite alternate;
}

@keyframes win {
  from { transform: scale(1); }
  to { transform: scale(1.1); color: gold; }
}

#stats {
  font-size: 14px;
}
</style>
</head>

<body>

<h1>ãƒ‹ãƒ ã‚²ãƒ¼ãƒ  Ultimate</h1>

<div class="controls">
  <select id="mode">
    <option value="cpu">VS CPU</option>
    <option value="pvp">2äººå¯¾æˆ¦</option>
  </select>

  <select id="difficulty">
    <option value="easy">CPUï¼šå¼±ã„</option>
    <option value="hard">CPUï¼šå¼·ã„</option>
  </select>

  <select id="rule">
    <option value="normal">é€šå¸¸ãƒ‹ãƒ </option>
    <option value="misere">ãƒŸã‚¼ãƒ¼ãƒ«</option>
  </select>

  <input id="pileCount" type="number" min="1" max="10" value="3">
  <input id="maxStone" type="number" min="1" max="10" value="5">

  <select id="initMode">
    <option value="manual">æ‰‹å‹•</option>
    <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
  </select>

  <button onclick="resetGame()">ğŸ” ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div class="piles" id="piles"></div>
<div class="pending" id="pending"></div>
<div id="message"></div>
<div id="stats"></div>

<audio id="takeSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="winSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
let piles = [];
let player = 1;
let selectedPile = null;
let selectedCount = null;
let pendingMove = null;

let stats = JSON.parse(localStorage.getItem("nimStats")) || { win: 0, lose: 0 };

function updateStats() {
  statsEl.textContent = `å‹ã¡: ${stats.win} / è² ã‘: ${stats.lose}`;
}

function createPiles() {
  const count = +pileCount.value;
  const max = +maxStone.value;
  const modeVal = initMode.value;
  piles = Array.from({ length: count }, () =>
    modeVal === "random" ? Math.floor(Math.random() * max) + 1 : max
  );
}

function resetGame() {
  createPiles();
  player = 1;
  pendingMove = null;
  selectedPile = null;
  selectedCount = null;
  message.classList.remove("win");
  message.textContent = "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ç•ª";
  render();
  updateStats();
}

function render() {
  pilesEl.innerHTML = "";

  piles.forEach((count, i) => {
    const div = document.createElement("div");
    div.className = "pile";

    let stones = "";
    for (let j = 0; j < count; j++) {
      const selected = i === selectedPile && j < selectedCount;
      stones += `<span class="stone ${selected ? "selected" : ""}"
        onpointerdown="selectStone(${i},${j + 1})">â—</span>`;
    }

    div.innerHTML = `<strong>å±±${i + 1}</strong>
                     <div class="stones">${stones}</div>`;
    pilesEl.appendChild(div);
  });

  pendingEl.innerHTML = pendingMove
    ? `å±±${pendingMove.pile + 1}ã‹ã‚‰ ${pendingMove.count}å€‹  
       <button onclick="confirmMove()">âœ… ç¢ºå®š</button>
       <button onclick="cancelMove()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`
    : "";
}

function selectStone(pile, count) {
  selectedPile = pile;
  selectedCount = count;
  pendingMove = { pile, count };
  render();
}

function cancelMove() {
  pendingMove = null;
  selectedPile = null;
  selectedCount = null;
  render();
}

function confirmMove() {
  if (!pendingMove) return;
  applyMove(pendingMove.pile, pendingMove.count);
  pendingMove = null;
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹
function applyMove(pile, count) {
  takeSound.play();
  piles[pile] -= count;
  selectedPile = null;
  selectedCount = null;

  const misere = rule.value === "misere";
  const end = piles.every(p => p === 0);

  if (end) {
    const winner = misere ? (player === 1 ? 2 : 1) : player;
    finishGame(winner);
    return;
  }

  if (mode.value === "cpu" && player === 1) {
    player = 2;
    render();
    setTimeout(cpuMove, 400);
  } else {
    player = player === 1 ? 2 : 1;
    message.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}ã®ç•ª`;
    render();
  }
}

// ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
function finishGame(winner) {
  message.textContent = `ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${winner}ã®å‹ã¡ï¼`;
  message.classList.add("win");
  winSound.play();

  if (mode.value === "cpu") {
    winner === 1 ? stats.win++ : stats.lose++;
    localStorage.setItem("nimStats", JSON.stringify(stats));
    updateStats();
  }
}

// AIã‚¿ãƒ¼ãƒ³
function cpuMove() {
  let move;
  if (difficulty.value === "hard") {
    move = rule.value === "misere" ? misereAI() : normalAI();
  } else {
    move = randomAI();
  }
  animateCpuMove(move.pile, move.count);
}

// AIã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
async function animateCpuMove(pile, count) {
  for (let i = 0; i < count; i++) {
    await new Promise(res => setTimeout(res, 200));
    piles[pile]--;
    takeSound.play();
    render();
  }

  const misere = rule.value === "misere";
  const end = piles.every(p => p === 0);
  if (end) {
    finishGame(2); // CPUå‹åˆ©
    return;
  }

  player = 1;
  message.textContent = "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ç•ª";
  render();
}

// AIãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè¿”ã‚Šå€¤: {pile, count}ï¼‰
function randomAI() {
  const i = piles.findIndex(p => p > 0);
  return { pile: i, count: 1 };
}

function normalAI() {
  const xor = piles.reduce((a, b) => a ^ b, 0);
  if (xor === 0) return randomAI();

  for (let i = 0; i < piles.length; i++) {
    const t = piles[i] ^ xor;
    if (t < piles[i]) return { pile: i, count: piles[i] - t };
  }
  return randomAI();
}

function misereAI() {
  const nonOne = piles.filter(p => p > 1).length;
  if (nonOne === 0) {
    const idx = piles.findIndex(p => p === 1);
    return { pile: idx, count: 1 };
  }
  return normalAI();
}

// DOMå‚ç…§
const pilesEl = document.getElementById("piles");
const pendingEl = document.getElementById("pending");
const message = document.getElementById("message");
const statsEl = document.getElementById("stats");
const pileCount = document.getElementById("pileCount");
const maxStone = document.getElementById("maxStone");
const mode = document.getElementById("mode");
const difficulty = document.getElementById("difficulty");
const rule = document.getElementById("rule");
const initMode = document.getElementById("initMode");
const takeSound = document.getElementById("takeSound");
const winSound = document.getElementById("winSound");

// åˆæœŸåŒ–
resetGame();
</script>

</body>
</html>
